digraph G {
    node [
        shape=rect;
    ];

    subgraph cluster_extension {
        label="Extension";
        
        subgraph cluster_extension_storage {
            label="Storage";

            extension_storage_modules [label="Storage modules"];

            subgraph cluster_extension_storex {
                label="Storex";

                subgraph cluster_extension_sync {
                    label="DEVELOPING: Sync layer";

                    extension_sync_transport [label="Sync log transport"];
                    extension_sync_logger [label="Operation logger"];
                    extension_sync_reconciler [label="Log reconciler"];
                    extension_sync_initial [label="Initial sync"];
                    extension_sync [label="", style="invis", width=0, height=0];
                }
                extension_database [label="Database (IndexedDB)"];
                extension_storex [label="", style="invis", width=0, height=0];
            }

            extension_storage_modules -> extension_storex;
        }

        subgraph cluster_background_page {
            label="Background page";
            
            extension_sharing_module [label="MISSING: Sharing module"];
            extension_backup_module [label="Backup module"];
            extension_auth_module [label="MISSING: Auth module"];
            extension_analytics [label="Analytics module"];
            extension_search_module [label="Search module"];
            extension_feature_modules [label="Feature modules\n(annotations, search, etc.)"];
        }

        subgraph cluster_content_scripts {
            label="Content scripts\n(injected into all pages)";

            extension_page_analyzer [label="Page analyzer"];
            extension_in_page_ui [label="In-page UI\n(tooltip, sidebar)"];
            extension_pdf_analyzer [label="MISSING: PDF analyzer"];
        }

        extension_in_page_ui -> extension_feature_modules;
        extension_in_page_ui -> extension_search_module;
        extension_pdf_analyzer -> extension_search_module;
        extension_page_analyzer -> extension_search_module;
        extension_feature_modules -> extension_storage_modules;
    }

    subgraph cluster_mobile {
        label="DEVELOPING: Mobile app"

        subgraph cluster_app_storage {
            label="Storage\n(same layout\nas extension)";

            app_database [label="Databae (SQLite)"];
            app_sync [label="Sync layer"];
        }
    }

    subgraph cluster_firebase_backend {
        label="Firebase backend";

        signalling_service [label="DEVELOPING: Signalling service"];
        premium_account_service [label="DEVELOPING: Premium account service"];
        following_service [label="MISSING: Content following service"];

        subgraph cluster_sync_service {
            label="DEVELOPING: Sync service";

            shared_sync_log [label="Shared Sync log\n(using Storex)"];
            sync_service [label="", style="invis", width=0, height=0];
        }

        auth_service [label="DEVELOPING: Auth service"];
        sharing_service [label="MISSING: Sharing service"];
        signalling_service -> auth_service;
        sync_service -> auth_service;
        sharing_service -> auth_service;
        sharing_service -> following_service;
    }

    subgraph cluster_aws_backend {
        label="AWS backend";

        AWS_S3 [label="S3"];
        AWS_CloudFront [label="CloudFront"];

        subgraph cluster_direct_linking_service {
            label="memex.link";

            direct_linking_service [label="Direct linking service"];
        }

        subgraph cluster_memex_root_service {
            label="memex.cloud";

            gdrive_login_service [label="GDrive login service"];
        }

        direct_linking_service -> AWS_S3;
        direct_linking_service -> AWS_CloudFront;
    }

    subgraph cluster_backup_backends {
        label="Backup backends";

        backup_backend_gdrive [label="Google Drive"];
        backup_backend_local [label="Local server"];
        backup_backends [label="", style="invis", width=0, height=0];
    }

    subgraph cluster_website {
        label="worldbrain.io website";

        website_content [label="Static content"];
        website_shop [label="Online shop"];
    }

    subgraph cluster_webinterface {
        label="MISSING: Web interface";

        webinterface_public_collections [label="Public collection UI"];
    }

    snipcart [label="Snipcart"];

    extension_sync_transport -> shared_sync_log;
    extension_sync -> premium_account_service;
    extension_sync_initial -> signalling_service;
    extension_backup_module -> backup_backends;
    extension_auth_module -> auth_service;
    extension_sharing_module -> sharing_service;
    extension_sharing_module -> following_service;

    app_sync -> shared_sync_log;

    website_shop -> snipcart;
    website_shop -> auth_service;

    webinterface_public_collections -> sharing_service;
    webinterface_public_collections -> auth_service;
}
